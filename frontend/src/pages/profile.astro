<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
</head>
<body>
    <div class="container">
    <h1>User Profile</h1>
    <div id="loading" class="loading">Loading...</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="profileInfo" class="profile-info">
      <div class="info-group">
        <div class="info-label">Username</div>
        <div class="info-value" id="username"></div>
      </div>
      <div class="info-group">
        <div class="info-label">First Name</div>
        <div class="info-value" id="firstname"></div>
      </div>
      <div class="info-group">
        <div class="info-label">Last Name</div>
        <div class="info-value" id="lastname"></div>
      </div>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <script>
    const loadingDiv = document.getElementById('loading') as HTMLDivElement;
    const errorDiv = document.getElementById('error') as HTMLDivElement;
    const profileInfoDiv = document.getElementById('profileInfo') as HTMLDivElement;
    const usernameSpan = document.getElementById('username') as HTMLSpanElement;
    const firstnameSpan = document.getElementById('firstname') as HTMLSpanElement;
    const lastnameSpan = document.getElementById('lastname') as HTMLSpanElement;
    const logoutBtn = document.getElementById('logoutBtn') as HTMLButtonElement;

    const getUserData = async () => {
      try {
        const res = await fetch('http://localhost:4500/check-auth', {
          method: 'GET',
          credentials: 'include'
        });

        if (!res.ok) {
          throw new Error('Not authenticated');
        }

        const data = await res.json();
        return data;
      } catch (error) {
        throw error;
      }
    };
    
    (async () => {
      try {
        const userData = await getUserData();
        
        
        usernameSpan.textContent = userData.username;
        firstnameSpan.textContent = userData.firstname;
        lastnameSpan.textContent = userData.lastname;

        loadingDiv.style.display = 'none';
        profileInfoDiv.classList.add('show');
      } catch (error) {
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'You must be logged in to view this page. Redirecting...';
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
      }
    })();

    logoutBtn.addEventListener('click', async () => {
      try {
        await fetch('http://localhost:4500/logout', {
          method: 'GET',
          credentials: 'include'
        });

        window.location.href = '/login';
      } catch (error) {
        alert('Logout failed. Please try again.');
      }
    });
  </script>
</body>
</html>